---
title: "Network Analysis of Stardom Wrestling Singles Title Matches"
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r SETUP, include = F}
knitr::opts_chunk$set(echo = TRUE)

options(java.parameters = "-Xmx8000m")
options(scipen=999)

library(readr)
library(readxl)
library(dplyr)
library(tidyverse)
library(lubridate)
library(scales)
library(colorspace)
library(ggthemes)
library(showtext)
library(igraph)
library(visNetwork)
library(knitr)
```

```{r STARDOM DATA PREP, include = F}
# UPDATE TO YOUR WORKING DIRECTORY
setwd("D:/Alejandro/Documents/R Projects/StardomData")

# IBM PLEX SANS
font_add(family = "IBM Plex Sans", # Name you want to use 
         regular = "IBMPlexSans-Regular.ttf",
         bold = "IBMPlexSans-Bold.ttf")

# IBM PLEX SANS LIGHT (FOR PLOT TEXT)
font_add(family = "IBM Plex Sans Light", # Name you want to use 
         regular = "IBMPlexSans-Light.ttf")

showtext_auto()

# levels for belts
belt_hierarchy <- c('NONE', 'FUTURE BELT', 'HIGH SPEED BELT', 
                    "ARTIST BELT", "TAG BELT",
                    'SWA BELT', 'WHITE BELT', 'RED BELT') %>% rev()

# belt color palette
belt_pal <- c('#fb6a4a',
              '#eff3ff',
              '#dfc27d',
              # "#8dd3c7",
              # "#fcc5c0",
              '#969696',
              '#abd9e9')

# custom function for title defenses
belter <- function(string = NULL) {
  out <- case_when(string %>% str_detect('CONTENDER|TOURNAMENT') ~ 'NONE',
                   string %>% str_detect('RED') ~ 'RED BELT',
                   string %>% str_detect('WHITE') ~ "WHITE BELT",
                   string %>% str_detect('TAG') ~ "TAG BELT",
                   string %>% str_detect('ARTIST') ~ "ARTIST BELT",
                   string %>% str_detect("HIGH SPEED") ~ "HIGH SPEED BELT",
                   string %>% str_detect('SWA') ~ "SWA BELT",
                   string %>% str_detect('FUTURE') ~ 'FUTURE BELT',
                   T ~ "NONE")
  out <-  factor(out, levels = belt_hierarchy)
  return(out)
}

# faction color palette function
gang_pal <- function(string = NULL) {
  out <- case_when(string %>% str_detect("QUEEN'S QUEST") ~ "#fdcc8a",
                   string %>% str_detect("OEDO TAI") ~ "#8856a7",
                   string %>% str_detect("DONNA DEL MONDO") ~ "#252525",
                   string %>% str_detect("COSMIC ANGELS") ~ "#fcc5c0",
                   string %>% str_detect("STARS") ~ "#f7f7f7",
                   string %>% str_detect("GOD'S EYE") ~ "#fb6a4a",
                   string %>% str_detect("UNAFFILIATED") ~ "#8cc2ca",
                   T ~ "#969696")
  return(out)
}

# belt color palette function
belter_pal <- function(string = NULL) {
  out <- case_when(string %>% str_detect('RED') ~ '#ef6f6a',
                   string %>% str_detect('WHITE') ~ "#fcfbfd",
                   string %>% str_detect("HIGH SPEED") ~ "#6388b4",
                   string %>% str_detect('SWA') ~ "#EDC948",
                   string %>% str_detect('FUTURE') ~ '#55ad89',
                   T ~ "NONE")
  return(out)
}


time_arrow <- function(date = NULL) {
  curr_yr = year(Sys.Date())
  diff = curr_yr - year(date)
  
  out <- case_when(diff %in% 0:1 ~ 0.7,
                   diff %in% 2:3 ~ 0.6,
                   diff %in% 4:5 ~ 0.4,
                   diff %in% 6:8 ~ 0.3,
                   T ~ 0.2)
  
  return(out)
}

# based off show_col(...)
show_legend <- function (colours, 
                         text = NULL,
                         labels = TRUE, borders = NULL, cex_label = 1, 
                         ncol = NULL) 
{
  n <- length(colours)
  ncol <- ncol %||% ceiling(sqrt(length(colours)))
  nrow <- ceiling(n/ncol)
  colours <- c(colours, rep(NA, nrow * ncol - length(colours)))
  colours <- matrix(colours, ncol = ncol, byrow = TRUE)
  old <- par(pty = "s", mar = c(0, 0, 0, 0))
  on.exit(par(old))
  size <- max(dim(colours))
  plot(c(0, size), c(0, -size), type = "n", xlab = "", ylab = "", 
       axes = FALSE)
  rect(col(colours) - 1, -row(colours) + 1, col(colours), -row(colours), 
       col = colours, border = borders)
  if (labels) {
    hcl <- farver::decode_colour(colours, "rgb", "hcl")
    label_col <- ifelse(hcl[, "l"] > 50, "black", "white")
    text(col(colours) - 0.5, -row(colours) + 0.5, text, 
         cex = cex_label, col = label_col)
  }
}

# manual mapping, kinda sucks
faction_map <- read_csv('Stardom Factions.csv') %>%
  mutate(NAME = str_squish(NAME))

# SET "Date" FIELD AS DATE-TYPE USING ymd(...)
# FLAG SINGLE MATCHES (BASED ON MATCH FIELDS WITH "/" OR "&)
# ADDITIONAL FLAG FOR 3 / 4 WAY MATCHES (MAY NOT BE CAPTURED IN SINGLE_FLG)
stardom <- read_excel("Stardom Match Guide.xlsx",
                      col_types = c("text", "text", "text", 
                                    "text", "text", "text", "text")) %>%
  rename_with(toupper) %>%
  mutate(DATE = ymd(DATE),
         MATCH = toupper(MATCH),
         NOTES = toupper(NOTES),
         WINNER = toupper(WINNER),
         SINGLE_FLG = !str_detect(string = MATCH, pattern = "/|&|MATCH"),
         MULTI_FLG = str_count(string = MATCH, pattern = "VS") > 1,
         BELT = belter(NOTES),
         TITLE_FLG = BELT != 'NONE',
         WINNER = case_when(WINNER == 'KAIRI HOJO' ~ "KAIRI", 
                            WINNER == "KAGETSU" ~ "YU ISHINO (FKA KAGETSU)",
                            WINNER %in% c("DEATH YAMA-SAN", "FUKIGEN DEATH") ~ "KAORI YONEYAMA",
                            T ~ WINNER)) %>%
  mutate(across(ends_with("_FLG"), ~ replace_na(., FALSE)))
```

# About World Wonder Ring Stardom

**World Wonder Ring Stardom** [スターダム 女子プロレス] (commonly referred to simply as *Stardom*) is a Japanese women's pro wrestling promotion that was founded in 2010 and quickly gained a reputation for very physical matches and their ability to develop young stars.
In 2019 Stardom was acquired by Japanese trading card game company Bushiroad alongside **New Japan Pro Wrestling** (NJPW), the largest wrestling promotion in the country.
In recent years, the company faced a tumultuous period of injuries, key retirements, and the tragic death of one of their future stars Hana Kimura just as the COVID-19 pandemic was starting.
The company was able to reset with a rebuilt roster and experienced one of their best periods of growth and acclaim.
According to Pro Wrestling Illustrated, Stardom averaged the second-most fans in Japan per event in 2021 placing it ahead of other notable promotions like Dragon Gate, NOAH, and All Japan (all of which have male-only rosters).

### Stardom Singles Championship Belts

This analysis focuses on the **singles championships** in Stardom (see table below).
Tag team, Trios, and non-title matches were excluded from analysis due to availability of data and to reduce complexity of data wrangling.

+------------------------------------+-------------------------------------+------------------+
| Championship Belt                  | Description                         | Current Champion |
+====================================+=====================================+==================+
| **World of Stardom Championship**  | Top championship in promotion       | Syuri            |
|                                    |                                     |                  |
| *(aka, Red Belt)*                  | in terms of prestige and history.   |                  |
+------------------------------------+-------------------------------------+------------------+
| **Wonder of Stardom Championship** | Second biggest prize in Stardom,    | Saya Kamitani    |
|                                    |                                     |                  |
| *(aka, White Belt)*                | but more than just a junior title.  |                  |
+------------------------------------+-------------------------------------+------------------+
| **High Speed Championship**        | Matches tend to be short but        | AZM              |
|                                    |                                     |                  |
|                                    | action packed with frenetic pacing. |                  |
+------------------------------------+-------------------------------------+------------------+
| **SWA Undisputed World**           | Champions are only allowed to       | Mayu Iwatani     |
|                                    |                                     |                  |
| **Women's Championship**           | defend title against wrestlers of   |                  |
|                                    |                                     |                  |
|                                    | a different nationality.            |                  |
+------------------------------------+-------------------------------------+------------------+
| **Future of Stardom Championship** | Can only be held by wrestlers       | Hanan            |
|                                    |                                     |                  |
|                                    | under 21 years old or with less     |                  |
|                                    |                                     |                  |
|                                    | than 3 years of experience.         |                  |
+------------------------------------+-------------------------------------+------------------+

### How to Watch

Stardom has a subscription service ([Stardom World](https://www.stardom-world.com/)) where new matches are uploaded with English subtitles a few days after they happen.

Edited highlights from their pay-per-view shows are also uploaded to the [Stardom Youtube Channel](https://www.youtube.com/c/STARDOMofficial/) several weeks later.
This is probably the easiest way to drop in and check out what they have to offer.

# Data and Methodology

Data used for analysis was based on a Google Sheet of [Stardom Recommended Matches](https://docs.google.com/spreadsheets/d/1uJ6cFxqg-A24q2GFb59KL8ic3vV-dBAn7cB7OJ8-rK0/edit?usp=sharing) with additional data wrangling to get necessary data structure for network analysis and plotting.
Title matches and outcomes were validated manually using [Cagematch](https://www.cagematch.net/?id=8&nr=745) entries.

Wrestlers with multiple aliases or newer names were manually consolidated under a single name where possible (e.g., *Yu Ishino* is used instead of their former *Kagetsu* name after recently coming out as trans).
Faction memberships were also mapped manually for **active** wrestlers and were based on the latest known affiliations at the time of analysis.

Data and R scripts used for this project can be found in [github](https://github.com/areyes13/StardomData)

```{r TABLE SAMPLE, echo = F, message = F, results = "asis"}
data <- stardom %>%
  # filter(DATE >= '2019-01-01') %>%
  filter(SINGLE_FLG) %>%
  filter(!str_detect(MATCH, 'RUMBLE')) %>%
  mutate(INDEX = row_number()) %>%
  separate_rows(MATCH, sep = 'VS') %>%
  mutate(MATCH = str_squish(MATCH)) %>%
  left_join(faction_map) %>%
  select(-MATCH)

title <- data %>%
  filter(TITLE_FLG,
         DATE >= '2010-01-01')

title %>%
  group_by(BELT) %>%
  summarise(`Title Contenders` = n_distinct(NAME),
            `Total Champions` = n_distinct(WINNER),
            `Total Matches` = n_distinct(INDEX)) %>%
  left_join(
    title %>%
      group_by(BELT, WINNER) %>%
      summarise(DEF = n_distinct(INDEX)) %>%
      group_by(BELT) %>%
      summarise(`Median Title Defenses` = median(DEF))
  ) %>%
  rename(Title = BELT) %>%
  kable(caption = 'Overview of Stardom Singles Championships')

```

### Network Analysis

Networks can be used to represent and study the relationships between objects or people.
In Network Analysis **nodes** represent the objects to be studied and **edges** represent the relationships between the nodes.

In this analysis, Stardom Wrestlers will act as the **nodes** while the **edges** will represent singles title matches with the following characteristics:

**Nodes**

-   Faction Membership - represented by node color for **active** wrestlers

-   Size - nodes with more edges linked to it will be larger (this refers to the *degree* of each node)

**Edges**

-   Direction - arrow identifies the winner of the match (from loser to winner; ties represented reciprocally)

-   Title - color of edge identifies which title was being contested

In the simplified example below, we can see that **Syuri** and **Mayu Iwatani** traded **Red Belt** losses with each other (represened by reciprocal edges between their nodes), while **Giulia** defeated **Syuri** in a **White Belt** title match.
The **size of the nodes** for Syuri and Mayu Iwatani are bigger than Giulia's because they have a larger number of total edges connected to them (i.e., they have a higher degree).

```{r EXAMPLE, echo = F}
n <- tibble(id = 1:3,
            group = c("GOD'S EYE", 'DONNA DEL MONDO', "STARS"),
            label = c("SYURI", "GUILIA", "MAYU IWATANI"),
            color.background = gang_pal(group),
            color.border = 'black',
            size = c(10,5,10) * 3,
            font.color = lighten(color.background, amount = 0.8))

e <- tibble(from = c(1,1,3), to = c(3,2,1),
            TITLE = c('RED BELT', 'WHITE BELT', 'RED BELT'),
            color.color = belter_pal(TITLE),
            arrows = "from",
            smooth.type = 'curvedCW',
            smooth.roundness = .5)

visNetwork(n, e, width = "100%",
           background = '#303030')
```

**Additional Readings:**

<https://cphss.wustl.edu/methodsandstrategies/social-network-analysis/network-analysis-101/>

<http://networksciencebook.com/>

<https://www.cs.cornell.edu/home/kleinber/networks-book/>

<https://kateto.net/network-visualization>

## Overall Network

```{r}
belts <- c("RED BELT", "WHITE BELT", "HIGH SPEED BELT", "SWA", "FUTURE")

show_legend(colours = belter_pal(belts),
            text = belts,
            ncol = 5)


factions <- c("COSMIC ANGELS", "DONNA DEL MONDO", "GOD'S EYE", "OEDO TAI", "QUEEN'S QUEST", "STARS", "UNAFFILIATED", "NOT ACTIVE")

show_legend(colours = gang_pal(factions),
            text = factions,
            ncol = 8)

belter_pal(belts)
gang_pal(factions)
```

```{r FULL NETWORK, echo=F, message=FALSE}


nodes <- title %>%
  distinct(NAME, FACTION) %>%
  filter(!is.na(NAME)) %>%
  arrange(NAME) %>%
  mutate(ID = row_number()) %>%
  left_join(title %>%
              count(NAME) %>%
              mutate(SIZE = n * 3.5)) %>%
  rename(GROUP = FACTION,
         LABEL = NAME) %>%
  mutate(color.background = gang_pal(GROUP),
         color.border = 'black',
         color.highlight.background = lighten(color.background, amount = 0.5),
         color.highlight.border = color.background,
         font.color = lighten(color.background, amount = 0.8),
         font.face = "IBM Plex Sans",
         font.size = case_when(GROUP != 'NOT ACTIVE' ~ 50,
                               T ~ 20),
         borderWidth = 2)



edges <- title %>%
  distinct(WINNER, NAME, BELT, INDEX, LINK, DATE) %>%
  filter(WINNER != NAME) %>%
  left_join(nodes %>% select(LABEL, ID, GROUP),
            by = c('WINNER' = "LABEL")) %>%
  rename(FROM = ID,
         FACTION = GROUP) %>%
  left_join(nodes %>% select(LABEL, ID),
            by = c('NAME' = "LABEL")) %>%
  rename(TO = ID) %>%
  filter(!is.na(FROM),
         !is.na(TO)) %>%
  rename(GROUP = BELT,
         TITLE = LINK) %>%
  mutate(WIDTH = 5,
         COLOR.COLOR = belter_pal(GROUP),
         COLOR.HIGHLIGHT = COLOR.COLOR,
         COLOR.OPACITY = time_arrow(DATE),
         ARROWS = "from",
         smooth.type = 'curvedCW',
         smooth.roundness = .5,
         selectionWidth = 7)

set.seed(666)
visNetwork(nodes %>%
             rename_with(tolower, -borderWidth), 
           edges %>%
             rename_with(tolower, -selectionWidth),
           height = "1000px", width = "100%",
           background = '#303030') %>%
  visOptions(highlightNearest = TRUE,
             selectedBy = 'group',
             nodesIdSelection = TRUE) %>%
  visPhysics(solver = "forceAtlas2Based",
             forceAtlas2Based = list(gravitationalConstant = -300,
                                     springConstant = 0.02,
                                     avoidOverlap = 0.5,
                                     springLength = 20,
                                     damping = 0.15),
             minVelocity = 45)
```

![](legend.png)

## Full Network Statistics

```{r NETWORK STAT OBJ, include = F, message = F}
net <- graph_from_data_frame(d = edges %>%
                               mutate(from = TO,
                                      to = FROM) %>%
                               select(from, to, GROUP) %>%
                               rename_with(tolower),
                             vertices = nodes %>%
                               select(ID, LABEL, GROUP, n) %>%
                               rename_with(tolower),
                             directed = T)
```

**Density:** The proportion of present edges from all possible edges in the network.

```{r DENSITY, echo = F}
ecount(net)/(vcount(net)*(vcount(net)-1))
```

**Reciprocity:** the proportion of reciprocated ties (for a directed network).

```{r RECIPROCITY, echo =F}
reciprocity(net)
```

**Average path length:** Mean of the shortest distance between each pair of nodes in the network

```{r AVG PATH, echo = F}
mean_distance(net, directed=T)
```

**Diameter:** Longest path between any two nodes.

```{r DIAMETER, echo=F, message=FALSE}


set.seed(666)

# ref table
d <- tibble(ID = get_diameter(net, directed=T) %>% 
              as_ids %>% 
              as.numeric()) %>%
  left_join(nodes %>%
              select(ID, GROUP, LABEL)) %>%
  select(LABEL, GROUP)

# vector of names to highlight
d_list <- d %>% pull(LABEL)

path_col <- tibble(EDGE = farthest_vertices(net, directed = T)$vertices %>%
                     {shortest_paths(net, .[1], .[2], output = "both")} %>%
                     .$epath %>%
                     .[[1]] %>%
                     as_ids()) %>%
  separate(col = "EDGE", c("TO","FROM"), sep = "\\|") %>%
  mutate(across(where(is.character), as.numeric),
         DUMMY = T)

# set new palette for nodes in vector
nodes_d <- title %>%
  distinct(NAME, FACTION) %>%
  filter(!is.na(NAME)) %>%
  arrange(NAME) %>%
  mutate(ID = row_number()) %>%
  left_join(title %>%
              count(NAME) %>%
              mutate(SIZE = n * 3.5)) %>%
  rename(GROUP = FACTION,
         LABEL = NAME) %>%
  mutate(GROUP = LABEL %in% d_list,
         color.background = case_when(LABEL %in% d_list ~ "#fc9272",
                                      T ~ "#eff3ff"),
         color.border = 'black',
         color.highlight.background = lighten(color.background, amount = 0.5),
         color.highlight.border = color.background,
         font.color = lighten(color.background, amount = 0.8),
         font.face = "IBM Plex Sans",
         font.size = case_when(GROUP ~ 70,
                               T ~ 0),
         borderWidth = 2)

edges_d <- edges %>%
  select(!starts_with("COLOR")) %>%
  distinct(FROM, TO, .keep_all = T) %>%
  unite("TEST", c(FROM, TO), remove = F) %>%
  left_join(path_col) %>%
  mutate(WIDTH = case_when(DUMMY ~ 10,
                           T ~ 5),
         COLOR.COLOR = case_when(DUMMY ~ "#fb6a4a",
                                 T ~ "#f7f7f7"),
         COLOR.OPACITY = case_when(DUMMY ~ 1,
                                 T ~ 0.3))


set.seed(666)
network_d <- visNetwork(nodes_d %>%
             rename_with(tolower, -borderWidth),
           edges_d %>%
             rename_with(tolower, -selectionWidth),
           height = "1000px", width = "100%",
           background = '#303030') %>%
  visPhysics(solver = "forceAtlas2Based",
             forceAtlas2Based = list(gravitationalConstant = -500,
                                     springConstant = 0.02,
                                     avoidOverlap = 0.5,
                                     springLength = 40,
                                     damping = 0.15),
             minVelocity = 45)

d %>% kable
network_d


```

**Hub:** statistic measuring number of *OUTGOING* links for each node.
In this context an *outgoing* link means a loss in a title match so we can use this statistic to loosely identify wrestlers that were regularly featured in key matches but didn't win the majority of the time.
Note that this statistic attempts to measure the quality of each "hub" by giving higher scores to nodes with *incoming* links as well as boosting hubs with outgoing links to other nodes with high degrees.
In other words, a high scoring hub will have a losing record in title matches, but those loses will tend be against more experienced opponents (measured by number of links).
Wrestlers without any *incoming* links (title wins) are not considered high quality hubs (sorry Jungle Kyona fans).

```{r HUB, echo = F, message= F}
hub <- hub_score(net, weights = NA)$vector %>% 
  as_tibble(rownames = NA) %>%
  rownames_to_column("ID") %>%
  mutate(ID = as.numeric(ID)) %>%
  left_join(nodes %>%
              select(ID, GROUP, LABEL)) %>%
  arrange(-value) %>%
  rename(NAME = LABEL,
         HUB = value)

# kable(hub %>% 
#         select(NAME, GROUP, HUB) %>%
#         head(10))

hub_list <- hub %>% pull(NAME) %>% head(10)
hub_list

# set new palette for nodes in vector
nodes_hub <- title %>%
  distinct(NAME, FACTION) %>%
  filter(!is.na(NAME)) %>%
  arrange(NAME) %>%
  mutate(ID = row_number()) %>%
  left_join(title %>%
              count(NAME) %>%
              mutate(SIZE = n * 3.5)) %>%
  rename(GROUP = FACTION,
         LABEL = NAME) %>%
  mutate(GROUP = LABEL %in% hub_list,
         color.background = case_when(LABEL %in% hub_list ~ "#6baed6",
                                      T ~ "#eff3ff"),
         color.border = 'black',
         color.highlight.background = lighten(color.background, amount = 0.5),
         color.highlight.border = color.background,
         font.color = lighten(color.background, amount = 0.8),
         font.face = "IBM Plex Sans",
         font.size = case_when(GROUP ~ 70,
                               T ~ 20),
         borderWidth = 2)

edges_hub <- edges %>%
  select(!starts_with("COLOR")) %>%
  distinct(FROM, TO, .keep_all = T) %>%
  mutate(COLOR.COLOR = case_when(NAME %in% hub_list ~ "#9ecae1",
                                 T ~ "#f7f7f7"),
         COLOR.HIGHLIGHT = case_when(NAME %in% hub_list ~ "white",
                                 T ~ "#f7f7f7"),
         COLOR.OPACITY = case_when(NAME %in% hub_list ~ 0.75,
                                 T ~ 0.3))

set.seed(666)
network_hub <- visNetwork(nodes_hub %>%
                            rename_with(tolower, -borderWidth),
                          edges_hub %>%
                            rename_with(tolower, -selectionWidth),
                          height = "1000px", width = "100%",
                          background = '#303030') %>%
  visPhysics(solver = "forceAtlas2Based",
             forceAtlas2Based = list(gravitationalConstant = -500,
                                     springConstant = 0.02,
                                     avoidOverlap = 0.5,
                                     springLength = 40,
                                     damping = 0.15),
             minVelocity = 45)

network_hub
```

**Authority:** Incoming links.
Measures wrestlers with high win rates against experienced title contenders (measured by number of links)

```{r AUTHORITY,  echo = F, message= F}
auth <- authority_score(net, weight = NA)$vector %>% 
  as_tibble(rownames = NA) %>%
  rownames_to_column("ID") %>%
  mutate(ID = as.numeric(ID)) %>%
  left_join(nodes %>%
              select(ID, GROUP, LABEL)) %>%
  arrange(-value) %>%
  rename(NAME = LABEL,
         AUTHORITY = value)

auth_list <- auth %>% pull(NAME) %>% head(10)

auth_list

# set new palette for nodes in vector
nodes_auth <- title %>%
  distinct(NAME, FACTION) %>%
  filter(!is.na(NAME)) %>%
  arrange(NAME) %>%
  mutate(ID = row_number()) %>%
  left_join(title %>%
              count(NAME) %>%
              mutate(SIZE = n * 3.5)) %>%
  rename(GROUP = FACTION,
         LABEL = NAME) %>%
  mutate(GROUP = LABEL %in% auth_list,
         color.background = case_when(LABEL %in% auth_list ~ "#78c679",
                                      T ~ "#eff3ff"),
         color.border = 'black',
         color.highlight.background = lighten(color.background, amount = 0.5),
         color.highlight.border = color.background,
         font.color = lighten(color.background, amount = 0.8),
         font.face = "IBM Plex Sans",
         font.size = case_when(GROUP ~ 70,
                               T ~ 20),
         borderWidth = 2)


edges_auth <- edges %>%
  select(!starts_with("COLOR")) %>%
  distinct(FROM, TO, .keep_all = T) %>%
  mutate(COLOR.COLOR = case_when(WINNER %in% auth_list ~ "#d9f0a3",
                                 T ~ "#f7f7f7"),
         COLOR.HIGHLIGHT = 'white',
         COLOR.OPACITY = case_when(WINNER %in% auth_list ~ 0.5,
                                 T ~ 0.3))

set.seed(666)
network_auth <- visNetwork(nodes_auth %>%
                            rename_with(tolower, -borderWidth),
                          edges_auth %>%
                            rename_with(tolower, -selectionWidth),
                          height = "1000px", width = "100%",
                          background = '#303030') %>%
  visPhysics(solver = "forceAtlas2Based",
             forceAtlas2Based = list(gravitationalConstant = -500,
                                     springConstant = 0.02,
                                     avoidOverlap = 0.5,
                                     springLength = 40,
                                     damping = 0.15),
             minVelocity = 45)

network_auth

```

**Closeness:** Closeness centrality indicates how close a node is to all other nodes in the network.
It is calculated as the average of the shortest path length from the node to every other node in the network

Individuals with high 'influence' over network

```{r CLOSENESS,  echo = F, message= F, results = "asis"}

close <- closeness(net, mode="all", weights=NA) %>% 
  as_tibble(rownames = NA) %>%
  rownames_to_column("ID") %>%
  mutate(ID = as.numeric(ID)) %>%
  left_join(nodes %>%
              select(ID, GROUP, LABEL)) %>%
  arrange(-value)

kable(close %>%
        rename(NAME = LABEL) %>%
        select(NAME, GROUP) %>%
        head(10))
```

**Eigenvector:** Eigenvector centrality is used to measure the level of influence of a node within a network.
Each node within the network will be given a score or value: the higher the score the greater the level of influence within the network.
This score is relative to the number of connections a node will have to other nodes.
Connections to high-scoring eigenvector centrality nodes contribute more to the score of the node than equal connections to low-scoring nodes.

```{r EIGENVECTOR, echo = F, message= F}

eigen_df <-eigen_centrality(net, directed=T, weights=NA)$vector %>% 
  as_tibble(rownames = NA) %>%
  rownames_to_column("ID") %>%
  mutate(ID = as.numeric(ID)) %>%
  left_join(nodes %>%
              select(ID, GROUP, LABEL)) %>%
  arrange(-value)

eigen_list <- eigen_df %>%
        rename(NAME = LABEL) %>%
        pull(NAME) %>%
        head(10)

eigen_list

# set new palette for nodes in vector
nodes_e <- title %>%
  distinct(NAME, FACTION) %>%
  filter(!is.na(NAME)) %>%
  arrange(NAME) %>%
  mutate(ID = row_number()) %>%
  left_join(title %>%
              count(NAME) %>%
              mutate(SIZE = n * 3.5)) %>%
  rename(GROUP = FACTION,
         LABEL = NAME) %>%
  mutate(GROUP = LABEL %in% eigen_list,
         color.background = case_when(LABEL %in% eigen_list ~ "#a8ddb5",
                                      T ~ "#eff3ff"),
         color.border = 'black',
         color.highlight.background = lighten(color.background, amount = 0.5),
         color.highlight.border = color.background,
         font.color = lighten(color.background, amount = 0.8),
         font.face = "IBM Plex Sans",
         font.size = case_when(GROUP ~ 70,
                               T ~ 20),
         borderWidth = 2)


edges_e <- edges %>%
  select(!starts_with("COLOR")) %>%
  distinct(FROM, TO, .keep_all = T) %>%
  mutate(COLOR.COLOR = case_when(WINNER %in% eigen_list ~ "#ccebc5",
                                 NAME %in% eigen_list ~ "#ccebc5",
                                 T ~ "#f7f7f7"),
         COLOR.HIGHLIGHT = 'white',
         COLOR.OPACITY = case_when(WINNER %in% eigen_list ~ 0.7,
                                 T ~ 0.3))

set.seed(666)
network_e <- visNetwork(nodes_e%>%
                          rename_with(tolower, -borderWidth),
                        edges_e %>%
                          rename_with(tolower, -selectionWidth),
                        height = "1000px", width = "100%",
                        background = '#303030') %>%
  visPhysics(solver = "forceAtlas2Based",
             forceAtlas2Based = list(gravitationalConstant = -500,
                                     springConstant = 0.02,
                                     avoidOverlap = 0.5,
                                     springLength = 40,
                                     damping = 0.15),
             minVelocity = 45)

network_e
```

**Betweenness:** Betweenness (Number of geodesics that pass through the node or the edge.) Vertices with high betweenness may have considerable influence within a network by virtue of their control over information passing between others.
They are also the ones whose removal from the network will most disrupt communications between other vertices because they lie on the largest number of paths taken by messages.

```{r BETWEEN, echo = F, message= F, results = "asis"}

between_df <- betweenness(net, directed=T, weights=NA) %>% 
  as_tibble(rownames = NA) %>%
  rownames_to_column("ID") %>%
  mutate(ID = as.numeric(ID)) %>%
  left_join(nodes %>%
              select(ID, GROUP, LABEL)) %>%
  arrange(-value)

kable(between_df %>%
        rename(NAME = LABEL) %>%
        select(NAME, GROUP) %>%
        head(10))
```

## Red Belt Sub Graph

```{r RED BELT ONLY, echo = F, message = F}
title_red <- data %>%
  filter(TITLE_FLG,
         BELT %in% c('RED BELT'),
         DATE >= '2010-01-01')




nodes_red <- title_red %>%
  distinct(NAME, FACTION) %>%
  filter(!is.na(NAME)) %>%
  arrange(NAME) %>%
  mutate(ID = row_number()) %>%
  left_join(title_red %>%
              count(NAME) %>%
              mutate(SIZE = n * 3.5)) %>%
  rename(GROUP = FACTION,
         LABEL = NAME) %>%
  mutate(color.background = gang_pal(GROUP),
         color.border = 'black',
         color.highlight.background = lighten(color.background, amount = 0.5),
         color.highlight.border = color.background,
         font.color = lighten(color.background, amount = 0.8),
         font.face = "IBM Plex Sans",
         font.size = case_when(GROUP != 'NOT ACTIVE' ~ 40,
                               T ~ 20),
         borderWidth = 2)



edges_red <- title_red %>%
  distinct(WINNER, NAME, BELT, INDEX, LINK, DATE) %>%
  filter(WINNER != NAME) %>%
  left_join(nodes_red %>% select(LABEL, ID, GROUP),
            by = c('WINNER' = "LABEL")) %>%
  rename(FROM = ID,
         FACTION = GROUP) %>%
  left_join(nodes_red %>% select(LABEL, ID),
            by = c('NAME' = "LABEL")) %>%
  rename(TO = ID) %>%
  filter(!is.na(FROM),
         !is.na(TO)) %>%
  rename(GROUP = BELT,
         TITLE = LINK) %>%
  mutate(WIDTH = 5,
         COLOR.COLOR = belter_pal(GROUP),
         COLOR.HIGHLIGHT = "white",
         COLOR.OPACITY = 0.7,
         ARROWS = "from",
         smooth.type = 'curvedCW',
         smooth.roundness = .5,
         selectionWidth = 7)


visNetwork(nodes_red %>%
             rename_with(tolower, -borderWidth), 
           edges_red %>%
             rename_with(tolower, -selectionWidth),
           height = "1000px", width = "100%",
           background = '#303030') %>%
  visOptions(highlightNearest = TRUE,
             selectedBy = 'group',
             nodesIdSelection = TRUE) %>%
  visPhysics(solver = "forceAtlas2Based",
             forceAtlas2Based = list(gravitationalConstant = -300,
                                     springConstant = 0.02,
                                     avoidOverlap = 0.5,
                                     springLength = 20,
                                     damping = 0.15),
             minVelocity = 35)
```

## White Belt Sub Graph

```{r WHITE BELT ONLY, echo = F, message = F}
title_white <- data %>%
  filter(TITLE_FLG,
         BELT %in% c('WHITE BELT'),
         DATE >= '2010-01-01')




nodes_white <- title_white %>%
  distinct(NAME, FACTION) %>%
  filter(!is.na(NAME)) %>%
  arrange(NAME) %>%
  mutate(ID = row_number()) %>%
  left_join(title_white %>%
              count(NAME) %>%
              mutate(SIZE = n * 3.5)) %>%
  rename(GROUP = FACTION,
         LABEL = NAME) %>%
  mutate(color.background = gang_pal(GROUP),
         color.border = 'black',
         color.highlight.background = lighten(color.background, amount = 0.5),
         color.highlight.border = color.background,
         font.color = lighten(color.background, amount = 0.8),
         font.face = "IBM Plex Sans",
         font.size = case_when(GROUP != 'NOT ACTIVE' ~ 40,
                               T ~ 20),
         borderWidth = 2)



edges_white <- title_white %>%
  distinct(WINNER, NAME, BELT, INDEX, LINK, DATE) %>%
  filter(WINNER != NAME) %>%
  left_join(nodes_white %>% select(LABEL, ID, GROUP),
            by = c('WINNER' = "LABEL")) %>%
  rename(FROM = ID,
         FACTION = GROUP) %>%
  left_join(nodes_white %>% select(LABEL, ID),
            by = c('NAME' = "LABEL")) %>%
  rename(TO = ID) %>%
  filter(!is.na(FROM),
         !is.na(TO)) %>%
  rename(GROUP = BELT,
         TITLE = LINK) %>%
  mutate(WIDTH = 5,
         COLOR.COLOR = belter_pal(GROUP),
         COLOR.HIGHLIGHT = "white",
         COLOR.OPACITY = 0.7,
         ARROWS = "from",
         smooth.type = 'curvedCW',
         smooth.roundness = .5,
         selectionWidth = 7)


visNetwork(nodes_white %>%
             rename_with(tolower, -borderWidth), 
           edges_white %>%
             rename_with(tolower, -selectionWidth),
           height = "1000px", width = "100%",
           background = '#303030') %>%
  visOptions(highlightNearest = TRUE,
             selectedBy = 'group',
             nodesIdSelection = TRUE) %>%
  visPhysics(solver = "forceAtlas2Based",
             forceAtlas2Based = list(gravitationalConstant = -300,
                                     springConstant = 0.02,
                                     avoidOverlap = 0.5,
                                     springLength = 20,
                                     damping = 0.15),
             minVelocity = 35)
```

*White Belt W/L Record*

```{r WHITE BELT BAR, echo = F, message=F}
title %>%
  filter(BELT %in% c('WHITE BELT')) %>%
  group_by(NAME, FACTION) %>%
  summarise(degree = n_distinct(INDEX),
            win = sum(WINNER == NAME),
            loss = sum(WINNER != NAME)) %>%
  mutate(loss = loss * -1) %>%
  gather(RESULT, COUNT, -NAME:-degree) %>%
  filter(degree >= 3) %>%
  ggplot(aes(reorder(NAME, abs(COUNT), sum), COUNT, fill = RESULT)) +
  geom_col(color = 'grey20')+
  geom_hline(yintercept = 0)+
  scale_y_continuous(name = '\nCount of White Belt Matches',
                     breaks = seq(-10,15, 5),
                     labels = c('10\nLosses', '5\nLosses', '0', '5\nWins', '10\nWins', '15\nWins'))+
  coord_flip()+
  theme_classic()+
  theme(text = element_text(family="IBM Plex Sans"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        legend.position = "right",
        legend.text = element_text(size = 16, family = 'IBM Plex Sans Light'),
        legend.title = element_text(size = 20),
        plot.title = element_text(face = 'bold', color = 'grey20', size = 30),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size = 20, face = "bold"),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 24),
        panel.border = element_blank(),
        plot.background = element_blank())
```

## Red Belt W/L

```{r RED, echo = F, message=F}
# Red Belt
title %>%
  filter(BELT %in% c('RED BELT')) %>%
  group_by(NAME, FACTION) %>%
  summarise(degree = n_distinct(INDEX),
            win = sum(WINNER == NAME),
            loss = sum(WINNER != NAME)) %>%
  mutate(loss = loss * -1) %>%
  gather(RESULT, COUNT, -NAME:-degree) %>%
  filter(degree >= 3) %>%
  ggplot(aes(reorder(NAME, abs(COUNT), sum), COUNT, fill = RESULT)) +
  geom_col(color = 'grey20')+
  geom_hline(yintercept = 0)+
  scale_y_continuous(name = '\nCount of Red Belt Matches',
                     breaks = seq(-10,15, 5),
                     labels = c('10\nLosses', '5\nLosses', '0', '5\nWins', '10\nWins', '15\nWins'))+
  coord_flip()+
  theme_classic()+
  theme(text = element_text(family="IBM Plex Sans"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        legend.position = "right",
        legend.text = element_text(size = 16, family = 'IBM Plex Sans Light'),
        legend.title = element_text(size = 20),
        plot.title = element_text(face = 'bold', color = 'grey20', size = 30),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size = 20, face = "bold"),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 24),
        panel.border = element_blank(),
        plot.background = element_blank())
```

## High Speed Belt Sub Graph

```{r HIGH SPEED BELT ONLY, echo = F, message = F}
title_speed <- data %>%
  filter(TITLE_FLG,
         BELT %in% c('HIGH SPEED BELT'),
         DATE >= '2010-01-01')




nodes_speed <- title_speed %>%
  distinct(NAME, FACTION) %>%
  filter(!is.na(NAME)) %>%
  arrange(NAME) %>%
  mutate(ID = row_number()) %>%
  left_join(title_speed %>%
              count(NAME) %>%
              mutate(SIZE = n * 3.5)) %>%
  rename(GROUP = FACTION,
         LABEL = NAME) %>%
  mutate(color.background = gang_pal(GROUP),
         color.border = 'black',
         color.highlight.background = lighten(color.background, amount = 0.5),
         color.highlight.border = color.background,
         font.color = lighten(color.background, amount = 0.8),
         font.face = "IBM Plex Sans",
         font.size = case_when(GROUP != 'NOT ACTIVE' ~ 40,
                               T ~ 20),
         borderWidth = 2)



edges_speed <- title_speed %>%
  distinct(WINNER, NAME, BELT, INDEX, LINK, DATE) %>%
  filter(WINNER != NAME) %>%
  left_join(nodes_speed %>% select(LABEL, ID, GROUP),
            by = c('WINNER' = "LABEL")) %>%
  rename(FROM = ID,
         FACTION = GROUP) %>%
  left_join(nodes_speed %>% select(LABEL, ID),
            by = c('NAME' = "LABEL")) %>%
  rename(TO = ID) %>%
  filter(!is.na(FROM),
         !is.na(TO)) %>%
  rename(GROUP = BELT,
         TITLE = LINK) %>%
  mutate(WIDTH = 5,
         COLOR.COLOR = belter_pal(GROUP),
         COLOR.HIGHLIGHT = "white",
         COLOR.OPACITY = 0.7,
         ARROWS = "from",
         smooth.type = 'curvedCW',
         smooth.roundness = .5,
         selectionWidth = 7)


visNetwork(nodes_speed %>%
             rename_with(tolower, -borderWidth), 
           edges_speed %>%
             rename_with(tolower, -selectionWidth),
           height = "1000px", width = "100%",
           background = '#303030') %>%
  visOptions(highlightNearest = TRUE,
             selectedBy = 'group',
             nodesIdSelection = TRUE) %>%
  visPhysics(solver = "forceAtlas2Based",
             forceAtlas2Based = list(gravitationalConstant = -300,
                                     springConstant = 0.02,
                                     avoidOverlap = 0.5,
                                     springLength = 20,
                                     damping = 0.15),
             minVelocity = 35)
```
